<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <title>Pair Genie</title>
  <style> table{ border: 1px solid black;} </style>
</head>
<body>
  <h1>Pair Genie</h1>
  <button id="addRowBtn">Add Name</button>
  <button id="addColBtn">Generate Pairs</button>
  <br>
  <br>
  <table id="dataTable">
    <thead>
      <tr>
	<th>Omit</th>
        <th>Name</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>Instructions</h3>
  1) Click "Add Name" and enter a new name. Repeat until all names are added.
  <br>2) Check the box in the "Omit" column, next to any name(s) to be left out of this round.
  <br>3) Click "Generate Pairs" to create a pairing. More names can be added for subsequent pairings.
  <br>
  <br>Note: Data are stored locally in your browser and persist until you press the "Clear Data" button below, or clear your browser's cache.
  <br>
  <br>
  <button id="clearBtn">Clear Data</button>
  <script>
    /* function to create a date stamp! */
    function yyyymmdd(){
      var d = new Date()
      var mm = d.getMonth() + 1; // getMonth() is zero-based
      var dd = d.getDate();
      return [d.getFullYear(), (mm > 9 ? '' : '0') + mm,
              		       (dd > 9 ? '' : '0') + dd].join('');
    }
  </script>

  <script>
    /* Durstenfeld shuffle, randomly permute an array: 
       https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle#The_modern_algorithm */
    function shuffle(X){
      for(var i = X.length - 1; i > 0; i--){
        var j = Math.floor(Math.random() * (i + 1));
        var temp = X[i];
        X[i] = X[j];
        X[j] = temp;
      }
      return X;
    }
  </script>

  <script>
    /* the software begins here */
    var table = document.getElementById("dataTable");  // table and button elements
    var tbody = table.getElementsByTagName("tbody")[0];
    var addRowBtn = document.getElementById("addRowBtn");
    var listDataBtn = document.getElementById("listData");
    
    var localStorageKey = "tableData";  // define localStorage key
    let tableData = JSON.parse(localStorage.getItem(localStorageKey)) || [];  // load table data from localStorage
    console.log("DATA", tableData)

    addRowBtn.addEventListener("click", addRow); // add hooks for the buttons
    addColBtn.addEventListener("click", addCol);
    clearBtn.addEventListener("click", clearData);
    
    var n_rows = parseInt(localStorage.getItem("n_rows"))
    var n_cols = parseInt(localStorage.getItem("n_cols"))
    if(!n_rows) n_rows = 0;
    if(!n_cols) n_cols = 1;
    console.log("N_COLS", n_cols) 

    var col_titles = JSON.parse(localStorage.getItem("col_titles")) || [];  // titles for additional cols
    if(!col_titles) col_titles = []; // start with empty array
    renderTableRows();  // render table rows from loaded data
    
    function renderTableRows(){
      table = document.getElementById("dataTable");
      table.innerHTML = "<thead><tr><th>Omit</th><th>Name</th></tr><thead>"
      table = document.getElementById("dataTable");
    
      var headerRow = table.rows[0];  // add a new table header cell
      while(table.rows[0].cells.length < n_cols + 1){
        var newHeaderCell = document.createElement("th");
        var new_col_title = col_titles[table.rows[0].cells.length - 2];
        newHeaderCell.textContent = new_col_title;
        headerRow.appendChild(newHeaderCell);
      }
    
      for(var i = 0; i < tableData.length; i++){
        const row = table.insertRow(-1);   // render table rows from loaded data
        const checkboxCell = row.insertCell(0)
        const nameCell = row.insertCell(1)
        checkboxCell.innerHTML = `<input type="checkbox" ${tableData[i].isChecked? "checked": ""} onchange="updateTableData(${i}, 'isChecked', this.checked)">`
        nameCell.innerHTML = `<input type="text" value="${tableData[i].name}" oninput="updateTableData(${i}, 'name', this.value)">`
    
        // render additional cols
        for(var j = 2; j <= n_cols; j++){
          // console.log(i, j)
          var nameCells = row.insertCell(j)
          var nameData = tableData[i]["name" + j.toString()]
          nameCells.innerHTML = `<input type="text" value="${nameData}" oninput="updateTableData(${i}, 'name${j}', this.value)">`
        }
      }
    }
    
    function fill_undefined(){
      for(var i = 1; i <= tableData.length; i++){
        for(var j = 1; j <= n_cols; j++){
          if(!tableData[i-1]["name" + j.toString()]){
            tableData[i-1]["name" + j.toString()] = ""
          }
        }
      }
    }
    
    function addRow(){
      const newRowData = {isChecked: false, name: ""}; tableData.push(newRowData);  // add a row to the table
      const rowIndex = tableData.length - 1;
      const row = table.insertRow(-1);
      const checkboxCell = row.insertCell(0);
      const nameCell = row.insertCell(1);
      checkboxCell.innerHTML = `<input type="checkbox" ${tableData[rowIndex].isChecked ? "checked" : ""} onchange="updateTableData(${rowIndex}, 'isChecked', this.checked)">`;
      nameCell.innerHTML = `<input type="text" value="" oninput="updateTableData(${rowIndex}, 'name', this.value)">`;
    
      n_rows = n_rows + 1
      for(var j = 2; j <= n_cols; j++){
        var new_cell = row.insertCell(-1);  // iterate over non-header rows
        new_cell.innerHTML = `<input type="text" value="" oninput="updateTableData(${rowIndex}, 'name${j}', this.value)">`;
        tableData[rowIndex]["name" + j.toString()] =  ""
      }
      saveTableData() // save updated table data to localStorage
    }
    
    function addCol(){
      var headerRow = table.rows[0];  // add a new table header cell
      var newHeaderCell = document.createElement("th");
      var new_col_title = yyyymmdd();
      newHeaderCell.textContent = new_col_title;
      col_titles.push(new_col_title);
      headerRow.appendChild(newHeaderCell);
    
      fill_undefined()  // put "" in any undefined slots
      for(var i = 1; i <= tableData.length; i++){
        var new_cell = table.rows[i].insertCell(-1);  // iterate over non-header rows
        var rowIndex = tableData.length - 1;
        var j = n_cols + 1;
        new_cell.innerHTML = `<input type="text" value="new" oninput="updateTableData(${rowIndex}, 'name${j}', this.value)">`;
        tableData[i - 1]["name" + (n_cols +1).toString()]= "";
      }
      n_cols = n_cols + 1
      create_pairing(); // use combinations to generate pairs
      renderTableRows();
      saveTableData();
    }
    
    function updateTableData(rowIndex, property, value){
      tableData[rowIndex][property] = value;  // update table data
      try{
        tableData[rowIndex][property] = tableData[rowIndex][property].trim();  // trim string data
      }
      catch(e){
        // pass
      }
      saveTableData();  // save to localStorage
    }
    
    function saveTableData(){
      console.log(tableData)
      localStorage.setItem(localStorageKey, JSON.stringify(tableData));  // save table data to localStorage
      localStorage.setItem("n_rows", n_rows.toString())
      localStorage.setItem("n_cols", n_cols.toString())
      localStorage.setItem("col_titles", JSON.stringify(col_titles));
    }

    function range(N){
      var X = []  // generate list of integers: [0, .., N-1]
      for(var i = 0; i < N; i++) X.push(i);
      return X;
    }

    function clone(X){
      return JSON.parse(JSON.stringify(X));  // deep copy a non-(reference-type) object
    }

    function create_pairing(){
      console.log("Create pairing..")
      // create some new matches
      var names = listNames();

      // list indices of available names
      var available = [];
      for(var i = 0; i < names.length; i++) if(!tableData[i].isChecked) available.push(i);
      
      console.log("Available", available)
      var use = shuffle(available);
      console.log("shuffled", use);

      for(var i = 0; i < use.length; i++){
	 var name_ix = use[i]  // index of name to assign a partner to AKA "me"
	 console.log("--------------me=", name_ix, names[name_ix])
	 var possible = new Set(use)  // possible partners
	 try{
           possible.remove(name_ix)  // don't partner with myself
	 }
	 catch{
	 }

         for(var j = 1; j <= n_cols; j++){
	   try{
             var s = tableData[name_ix]["name" + j.toString()]
             if(s) possible.remove(s);
           }
           catch{
	   }
         }
	 console.log(names[name_ix], "possible", possible)

         // list of available names other than me

	 // scan my row, removing from this list names I already met with

      }
      // put the matches in the new column

      // don't forget to add omit function
    }
    
    function listNames(){
      var tableDataArray = [];
      var tableRows = table.getElementsByTagName("tr");   // list table data to console
      for(var i = 1; i < tableRows.length; i++){
        var rowData = tableRows[i].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value;  // get value of second cell
        tableDataArray.push(rowData);
      }
      return tableDataArray;
    }
    
    function clearData(){
      n_rows = 0
      n_cols = 0
      tableData = null;
      localStorage.removeItem("n_rows")
      localStorage.removeItem("n_cols")
      localStorage.removeItem("col_titles")
      localStorage.removeItem(localStorageKey);
      location.reload()
    }
</script>
</body>
</html>
